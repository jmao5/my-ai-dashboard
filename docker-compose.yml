version: '3.8'

services:
  # 1. í”„ë¡ íŠ¸ì—”ë“œ
  frontend:
    image: node:20-alpine
    container_name: dash-frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    ports:
      - "9014:3000"
    command: sh -c "npm install && npm run dev"
    environment:
      - WATCHPACK_POLLING=true
      # .env íŒŒì¼ì—ì„œ ì½ì–´ì˜µë‹ˆë‹¤ ğŸ‘‡
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_AI_URL=${NEXT_PUBLIC_AI_URL}
    depends_on:
      - backend-core
    networks:
      - dash-net

  # 2. ì‹œìŠ¤í…œ ë°±ì—”ë“œ (Go)
  backend-core:
    image: golang:1.25-alpine
    container_name: dash-core
    working_dir: /app
    volumes:
      - ./backend-core:/app
      - /var/run/docker.sock:/var/run/docker.sock # Go ì„œë²„ê°€ í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ë¥¼ ë§Œì§ˆ ìˆ˜ ìˆê²Œ ê¶Œí•œ ë¶€ì—¬
    ports:
      - "9015:8080"
    command: sh -c "go install github.com/air-verse/air@v1.52.3 && air"
    environment:
      # DB ì ‘ì† ì •ë³´ë„ ë³€ìˆ˜ë¡œ ì²˜ë¦¬ ğŸ‘‡
      - DB_DSN=host=db user=${POSTGRES_USER} password=${POSTGRES_PASSWORD} dbname=${POSTGRES_DB} port=5432 sslmode=disable
      - AI_SERVICE_URL=http://backend-ai:8000
    networks:
      - dash-net

  # 3. AI ë°±ì—”ë“œ (Python)
  backend-ai:
    image: python:3.11-slim
    container_name: dash-ai
    working_dir: /app
    volumes:
      - /home/jsh/docker/my-dashboard/backend-ai:/app
    ports:
      - "9016:8000"
    command: sh -c "pip install -r requirements.txt && python main.py"
    environment:
      # ê°€ì¥ ì¤‘ìš”í•œ API í‚¤! ğŸ‘‡
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      # DB ì ‘ì† ì •ë³´
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    networks:
      - dash-net

  # 4. ë°ì´í„°ë² ì´ìŠ¤
  db:
    image: postgres:15-alpine
    container_name: dash-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "9017:5432"
    networks:
      - dash-net

volumes:
  postgres_data:

networks:
  dash-net:
    driver: bridge