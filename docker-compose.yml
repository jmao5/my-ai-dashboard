version: '3.8'

services:
  # 1. í”„ë¡ íŠ¸ì—”ë“œ
  frontend:
    build: ./frontend
    container_name: dash-frontend
    # working_dir: /app  <-- (ì„ íƒ) Dockerfileì— ìžˆì–´ì„œ ì—†ì–´ë„ ë¨

    # âŒ [ì‚­ì œ] ì´ì œ ì†ŒìŠ¤ì½”ë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—°ê²°í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
    # volumes:
    #   - ./frontend:/app

    ports:
      - "9014:3000"
    # âŒ [ì‚­ì œ] commandë„ ì§€ìš°ì„¸ìš” (Dockerfile CMDê°€ ì‹¤í–‰ë¨)
    # command: sh -c "npm install && npm run dev"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_AI_URL=${NEXT_PUBLIC_AI_URL}
      - NEXTAUTH_URL=http://sso.tplinkdns.com:9014
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    depends_on:
      - backend-core
    networks:
      - dash-net

  # 2. ì‹œìŠ¤í…œ ë°±ì—”ë“œ (Go)
  backend-core:
    build: ./backend-core
    container_name: dash-core

    # âŒ [ì‚­ì œ] ì‹¤í–‰ íŒŒì¼ì´ ìžˆëŠ” ê³³ì„ ë®ì–´ì“°ë©´ ì•ˆ ë©ë‹ˆë‹¤!
    # volumes:
    #   - ./backend-core:/app
    # ðŸ‘‡ ë‹¨, ë„ì»¤ ì†Œì¼“ì€ í•„ìš”í•˜ë‹ˆ ì´ê²ƒë§Œ ë‚¨ê¸°ê±°ë‚˜, volumes ìžì²´ë¥¼ ë‹¤ì‹œ ì”ë‹ˆë‹¤.
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    ports:
      - "9015:8080"
    # âŒ [ì‚­ì œ]
    # command: ...
    environment:
      - DB_DSN=host=db user=${POSTGRES_USER} password=${POSTGRES_PASSWORD} dbname=${POSTGRES_DB} port=5432 sslmode=disable
      - AI_SERVICE_URL=http://backend-ai:8000
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - ALERT_THRESHOLD_CPU=${ALERT_THRESHOLD_CPU}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    networks:
      - dash-net

  # 3. AI ë°±ì—”ë“œ (Python) - ì–˜ëŠ” ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤ (ê°œë°œ ëª¨ë“œ ìœ ì§€í•´ë„ ë¨)
  backend-ai:
    image: python:3.11-slim
    container_name: dash-ai
    working_dir: /app
    # Pythonì€ ìŠ¤í¬ë¦½íŠ¸ ì–¸ì–´ë¼ ìˆ˜ì • ë¹ˆë„ê°€ ë†’ìœ¼ë‹ˆ Volume ìœ ì§€í•´ë„ ê´œì°®ìŠµë‹ˆë‹¤.
    volumes:
      - /home/jsh/docker/my-dashboard/backend-ai:/app
    ports:
      - "9016:8000"
    command: sh -c "pip install -r requirements.txt && python main.py"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    networks:
      - dash-net

  # 4. DB (ìœ ì§€)
  db:
    image: postgres:15-alpine
    container_name: dash-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "9017:5432"
    networks:
      - dash-net

volumes:
  postgres_data:

networks:
  dash-net:
    driver: bridge