version: '3.8'

services:
  # 1. í”„ë¡ íŠ¸ì—”ë“œ
  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_AI_URL: ${NEXT_PUBLIC_AI_URL}
    container_name: dash-frontend
    ports:
      - "9014:3000"
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_AI_URL=${NEXT_PUBLIC_AI_URL}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - TZ=Asia/Seoul
    depends_on:
      - backend-core
    networks:
      - dash-net
    volumes:
      - /etc/localtime:/etc/localtime:ro

  # 2. ì‹œìŠ¤í…œ ë°±ì—”ë“œ (Go)
  backend-core:
    build: ./backend-core
    container_name: dash-core
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "9015:8080"
    restart: always
    environment:
      - TZ=Asia/Seoul
      - DB_DSN=host=db user=${POSTGRES_USER} password=${POSTGRES_PASSWORD} dbname=${POSTGRES_DB} port=5432 sslmode=disable
      - AI_SERVICE_URL=http://backend-ai:8000
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - ALERT_THRESHOLD_CPU=${ALERT_THRESHOLD_CPU}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    networks:
      - dash-net

  # 3. AI ë°±ì—”ë“œ (Python)
  backend-ai:
    image: python:3.11-slim
    container_name: dash-ai
    working_dir: /app
    volumes:
      - ./backend-ai:/app
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "9016:8000" # âš ï¸ 9016 í¬íŠ¸ ì‚¬ìš© ì¤‘
    restart: always
    command: sh -c "pip install -r requirements.txt && python main.py"
    environment:
      - TZ=Asia/Seoul
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    networks:
      - dash-net

  # 4. ìë°” ìë™ë§¤ë§¤ ë°±ì—”ë“œ (Spring Boot) - [ì¶”ê°€ë¨]
  backend-trade:
    build: ./backend-trade
    container_name: dash-trade
    restart: always
    ports:
      - "9018:9016" # âš ï¸ AIì™€ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ì™¸ë¶€ í¬íŠ¸ë¥¼ 9018ë¡œ ì„¤ì •
    environment:
      - TZ=Asia/Seoul
      # ğŸ‘‡ ë„ì»¤ ë‚´ë¶€ DB ì£¼ì†Œ(db:5432)ë¡œ ì—°ê²° ì£¼ì…
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/${POSTGRES_DB}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}
      # í•œêµ­íˆ¬ìì¦ê¶Œ API í‚¤ (í•„ìš”í•˜ë‹¤ë©´ .env íŒŒì¼ì— ì¶”ê°€ í›„ ì‚¬ìš©)
      - KIS_APP_KEY=${KIS_APP_KEY}
      - KIS_APP_SECRET=${KIS_APP_SECRET}
    depends_on:
      - db
    networks:
      - dash-net
    volumes:
      - /etc/localtime:/etc/localtime:ro

  # 5. DB (PostgreSQL)
  db:
    image: pgvector/pgvector:pg16
    container_name: dash-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      TZ: Asia/Seoul
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "9017:5432"
    restart: always
    networks:
      - dash-net

volumes:
  postgres_data:

networks:
  dash-net:
    driver: bridge